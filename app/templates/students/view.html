{% extends 'base.html' %}
{% block title %}{{ student.full_name }} â€” MTB School{% endblock %}
{% block content %}
<div class="content-wrapper">
    <div class="page-header">
        <div>
            <ul class="breadcrumb">
                <li><a href="{{ url_for('students.list_students') }}">Students</a></li>
                <li>{{ student.full_name }}</li>
            </ul>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('students.edit_student', id=student.id) }}" class="btn btn-secondary">âœï¸ Edit</a>
            <a href="{{ url_for('face.register') }}" class="btn btn-outline">ğŸ¤– Register Face</a>
        </div>
    </div>

    <div class="grid-2">
        <div>
            <div class="profile-card">
                <div class="profile-header">
                    <div class="profile-avatar">
                        {% if student.photo %}<img src="{{ url_for('static', filename=student.photo) }}" alt="">{% else
                        %}{{ student.full_name[0]|upper }}{% endif %}
                    </div>
                    <div class="profile-name">
                        <h2>{{ student.full_name }}</h2>
                        <p>{{ student.class_section.display_name if student.class_section else 'No Class' }}</p>
                    </div>
                </div>
                <div class="profile-body">
                    <div style="margin-bottom:16px;display:flex;gap:8px;flex-wrap:wrap">
                        <span class="reg-no">{{ student.reg_no }}</span>
                        <span
                            class="badge {% if student.status == 'active' %}badge-success{% else %}badge-danger{% endif %}">{{
                            student.status|capitalize }}</span>
                        {% if student.has_face_registered %}<span class="badge badge-info">ğŸ¤– Face Registered</span>{%
                        endif %}
                    </div>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Father's Name</div>
                            <div class="info-value">{{ student.father_name or 'â€”' }}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Mother's Name</div>
                            <div class="info-value">{{ student.mother_name or 'â€”' }}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Date of Birth</div>
                            <div class="info-value">{{ student.date_of_birth.strftime('%d %b %Y') if
                                student.date_of_birth else 'â€”' }}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Gender</div>
                            <div class="info-value">{{ student.gender or 'â€”' }}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Blood Group</div>
                            <div class="info-value">{{ student.blood_group or 'â€”' }}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">CNIC</div>
                            <div class="info-value">{{ student.cnic or 'â€”' }}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Phone</div>
                            <div class="info-value">{{ student.phone or 'â€”' }}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Parent Phone</div>
                            <div class="info-value">{{ student.parent_phone or 'â€”' }}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Email</div>
                            <div class="info-value">{{ student.email or 'â€”' }}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">City</div>
                            <div class="info-value">{{ student.city or 'â€”' }}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Admission Date</div>
                            <div class="info-value">{{ student.admission_date.strftime('%d %b %Y') if
                                student.admission_date else 'â€”' }}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Address</div>
                            <div class="info-value">{{ student.address or 'â€”' }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div>
            <!-- Attendance Stats -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">âœ… Attendance Summary</div>
                </div>
                <div class="card-body">
                    <div class="d-flex gap-3 align-center mb-3">
                        <div style="text-align:center;flex:1">
                            <div style="font-size:32px;font-weight:800;color:var(--primary)">{{ att_pct }}%</div>
                            <div style="font-size:12px;color:var(--text-muted)">Attendance Rate</div>
                        </div>
                        <div style="text-align:center;flex:1">
                            <div style="font-size:24px;font-weight:700;color:#059669">{{ present_count }}</div>
                            <div style="font-size:12px;color:var(--text-muted)">Days Present</div>
                        </div>
                        <div style="text-align:center;flex:1">
                            <div style="font-size:24px;font-weight:700;color:#dc2626">{{ total_att - present_count }}
                            </div>
                            <div style="font-size:12px;color:var(--text-muted)">Days Absent</div>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill {% if att_pct >= 75 %}green{% elif att_pct >= 50 %}warning{% else %}danger{% endif %}"
                            style="width:{{ att_pct }}%"></div>
                    </div>
                    <div style="margin-top:14px">
                        {% for att in recent_attendance[:5] %}
                        <div
                            style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)">
                            <span style="font-size:13px;color:var(--text-muted)">{{ att.date.strftime('%d %b %Y')
                                }}</span>
                            <span
                                class="badge {% if att.status == 'present' %}badge-success{% elif att.status == 'absent' %}badge-danger{% elif att.status == 'late' %}badge-warning{% else %}badge-info{% endif %}">{{
                                att.status|capitalize }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Recent Fees -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ğŸ’° Recent Payments</div>
                    <a href="{{ url_for('fees.record_payment') }}" class="btn btn-primary btn-sm">+ Record Fee</a>
                </div>
                <div class="card-body" style="padding:0">
                    {% if fee_payments %}
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Receipt</th>
                                <th>Amount</th>
                                <th>Month</th>
                                <th>Date</th>
                                <th>PDF</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in fee_payments %}
                            <tr>
                                <td style="font-family:monospace;font-size:12px">{{ p.receipt_no }}</td>
                                <td>PKR {{ "{:,.0f}".format(p.total_paid) }}</td>
                                <td>{{ p.month or 'â€”' }}</td>
                                <td>{{ p.payment_date.strftime('%d %b') if p.payment_date else 'â€”' }}</td>
                                <td><a href="{{ url_for('fees.download_receipt', id=p.id) }}" class="action-btn pdf"
                                        target="_blank">ğŸ“„</a></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="empty-state" style="padding:28px">
                        <div class="empty-state-icon" style="font-size:32px">ğŸ’°</div>
                        <div>No fee records found</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}