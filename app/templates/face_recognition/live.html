{% extends 'base.html' %}
{% block title %}Live Face Recognition ‚Äî MTB School{% endblock %}
{% block body_attr %}data-face-mode="live"{% endblock %}
{% block extra_js %}
<script src="{{ url_for('static', filename='js/face-recognition.js') }}"></script>{% endblock %}
{% block content %}
<div class="content-wrapper">
    <div class="page-header">
        <div>
            <h1 class="page-title text-primary"><span class="pulse-dot">üî¥</span> Live Recognition Feed</h1>
            <p class="page-subtitle">Continuous background facial recognition for gate entry</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('face.mark') }}" class="btn btn-outline">üì∏ Manual Mark</a>
            <a href="{{ url_for('face.register') }}" class="btn btn-secondary">ü§ñ Register Faces</a>
        </div>
    </div>

    {% if not available %}
    <div class="face-unavailable">
        <div class="icon">üõ†Ô∏è</div>
        <h3>Face Recognition Not Available</h3>
        <p>Install <code>face-recognition</code> and <code>opencv-python-headless</code>.</p>
    </div>
    {% else %}
    <div class="grid-2">
        <!-- Camera Side -->
        <div>
            <div class="camera-card">
                <div class="camera-header">
                    <span class="camera-title">Live Camera</span>
                    <div class="camera-status live">
                        <div class="status-dot"></div><span>Processing...</span>
                    </div>
                </div>
                <div class="camera-feed-wrapper" style="height:380px">
                    <video id="camera-video" autoplay muted playsinline></video>
                    <canvas id="camera-canvas" style="position:absolute;top:0;left:0;width:100%;height:100%"></canvas>
                    <div class="scan-line" id="scan-line" style="display:none;animation-duration:2s"></div>
                    <div class="camera-placeholder" style="display:none" id="camera-placeholder">
                        <div class="camera-placeholder-icon">üì∑</div>
                        <div class="camera-placeholder-text">Camera Off</div>
                    </div>
                </div>
                <div class="camera-footer" style="justify-content:space-between">
                    <div>
                        <span style="font-size:12px;color:var(--text-muted);font-weight:600">FPS: <span id="fps-counter"
                                style="color:var(--primary)">0</span></span>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" id="start-camera-btn">‚ñ∂ Start</button>
                        <button class="btn btn-outline" id="stop-camera-btn" style="display:none">‚èπ Stop</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Side -->
        <div>
            <div class="card" style="height:100%;display:flex;flex-direction:column">
                <div class="card-header">
                    <div class="card-title">Recent Detections</div>
                    <span class="badge badge-success">Auto-marking Attendance</span>
                </div>
                <div class="card-body" style="flex:1;overflow-y:auto;padding:0" id="live-results-container">
                    <!-- Real-time results appended here -->
                    <div class="empty-state" id="live-empty-state" style="padding:40px;height:100%">
                        <div class="empty-state-icon" style="font-size:48px;animation: pulse 2s infinite">üì°</div>
                        <div class="empty-state-title">Waiting for faces...</div>
                        <div class="text-muted" style="margin-top:8px">Detected students will be marked present
                            automatically</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes pulse {
            0% {
                transform: scale(0.95);
                opacity: 0.5;
            }

            50% {
                transform: scale(1.05);
                opacity: 1;
            }

            100% {
                transform: scale(0.95);
                opacity: 0.5;
            }
        }

        .pulse-dot {
            display: inline-block;
            animation: pulse 1.5s infinite;
        }

        .live-detection-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
        }

        .live-detection-item.unknown {
            border-left: 4px solid var(--danger);
        }

        .live-detection-item.known {
            border-left: 4px solid var(--success);
        }

        @keyframes slideIn {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
    {% endif %}
</div>
{% endblock %}